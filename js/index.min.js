var nodegrass=require("nodegrass");var moment=require("moment");var gui=require("nw.gui");var win=gui.Window.get();var fs=require("fs");var recvjsondata="";var recvmusicdata="";var pulldate="";var imgdate="";var pic="";var text_short="";var color_back="";var bigpicurl2x="";var mawae="";var musicurl="";var musicname="";var musicartist="";var nitingcode="";var dateType="";win.setResizable(0);function getDate(c){var d=moment().get("month")+1;var a=moment().get("date");var b;if(d<10){d="0"+d}if(a<10){a="0"+a}switch(c){case"json":b=moment().get("year")+"/"+d+"/"+a;return b;break;case"image":b=""+moment().get("year")+d+a;return b;break;default:console.log("Error:Date Argument Not Found!");break}}function getjsonDate(){dateType="json";out=getDate(dateType);return out;dataType=""}function getimgDate(){dateType="image";out=getDate(dateType);return out;dataType=""}function getmonth(){var a=new Array(12);a[0]="JAN";a[1]="FEB";a[2]="MAR";a[3]="APR";a[4]="MAY";a[5]="JUN";a[6]="JUL";a[7]="AUG";a[8]="SEP";a[9]="OCT";a[10]="NOV";a[11]="DEC";return a[moment().get("month")]}function getweekday(){var a=new Array(7);a[0]="SUNDAY";a[1]="MONDAY";a[2]="TUESDAY";a[3]="WEDNESDAY";a[4]="THURSDAY";a[5]="FRIDAY";a[6]="SATURDAY";return a[moment().get("day")]}function getday(){var a=moment().get("date");if(a<10){a="0"+a}return""+a}function getinfo(){nodegrass.get("http://nichijou.in/LastDay/"+pulldate+".json",function(d){recvjsondata=d;recvjsondata=JSON.parse(recvjsondata);pic=recvjsondata[imgdate]["images"]["big568h2x"].replace("{img}","http://nextday-pic.b0.upaiyun.com");if(recvjsondata[imgdate]["geo"]){geo=recvjsondata[imgdate]["geo"]["reverse"]}else{var c=new RegExp("^[^.]+","g");var e=recvjsondata[imgdate]["text"]["comment2"];geo=c.exec(e)}geo=geo.replace(",",", ");if(recvjsondata[imgdate]["text"]["short"]){text_short=recvjsondata[imgdate]["text"]["short"].replace(/,/g,", ")}else{var b=new RegExp("[^.]+$","g");var e=recvjsondata[imgdate]["text"]["comment2"];text_short=recvjsondata[imgdate]["text"]["comment1"]+","+b.exec(e);text_short=text_short.replace(/,/g,", ")}color_back=recvjsondata[imgdate]["colors"]["background"];if(recvjsondata[imgdate]["music"]){if(recvjsondata[imgdate]["music"]["url"]){musicurl=recvjsondata[imgdate]["music"]["url"].replace("{music}","http://nextday-file.b0.upaiyun.com/");$("#todaymusic").attr("src",musicurl)}else{nitingcode=recvjsondata[imgdate]["music"]["nitingCode"];nodegrass.get("http://www.niting.com/iphone.do?method=getMusicUrlByCode&musiccode="+nitingcode,function(f){recvmusicdata=f;recvmusicdata=JSON.parse(recvmusicdata);musicurl=recvmusicdata.object["dc_musicurl"];$("#todaymusic").attr("src",musicurl)},null,"utf8")}musicname=recvjsondata[imgdate]["music"]["name"];musicartist=recvjsondata[imgdate]["music"]["artist"]}else{musicname="There is no music here.";musicartist=""}if(recvjsondata[imgdate]["event"]){mawae=getmonth()+". "+getweekday()+", "+recvjsondata[imgdate]["event"]}else{mawae=getmonth()+". "+getweekday()}$("#background").css("background-color",color_back);$("#mawae").html(mawae);$("#day").html(getday());$("#geo").html(geo);$("#short").html(text_short);$("#songname").html(musicname);$("#artist").html(musicartist);$("#cover").css("background-image","url('"+pic+"')");function a(){var f=setTimeout("$('#startup').fadeOut()",3000)}a()},null,"utf8")}function getupdate(){fs.readFile("./package.json",{encoding:"utf8",flag:"r"},function(a,c){if(a){throw a}var d=JSON.parse(c);var b=d.version;nodegrass.get("http://nd.nichijou.in/latestversion",function(e){if(b==e){console.log("Up to date")}else{alert("有新版本！请到官网下载\n目前版本:"+b+"\n最新版本:"+e)}},null,"utf8")})}$(document).ready(function(){pulldate=getjsonDate();imgdate=getimgDate();$("#page").mouseenter(function(){$("#winctrl").fadeIn();if($("#timemachine").css("display")==="none"){$("#tmopen").fadeIn()}});$("#page").mouseleave(function(){$("#winctrl").fadeOut();if($("#timemachine").css("display")==="none"){$("#tmopen").fadeOut()}});$("#tmopen").click(function(){$("#timemachine").fadeIn();$("#tmopen").css("display","none")});$("#tmexit").click(function(){$("#timemachine").fadeOut();$("#tmopen").css("display","")});$("#min").click(function(){win.minimize()});$("#exit").click(function(){win.close()});$("#play-pause-button").click(function(){if(document.getElementById("todaymusic").paused){$("#play-pause-button").removeClass("play").addClass("pause");document.getElementById("todaymusic").play()}else{$("#play-pause-button").removeClass("pause").addClass("play");document.getElementById("todaymusic").pause()}});document.getElementById("todaymusic").addEventListener("ended",function(){$("#play-pause-button").removeClass("pause").addClass("play")});getupdate();getinfo()});win.on("close",function(){$("#exitpage").fadeIn();function a(){var b=setTimeout("win.close(true)",2500)}a()});